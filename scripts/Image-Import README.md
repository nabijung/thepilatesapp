# Prospire Image Import Script

This script imports student profile images and studio progress photos from Firebase Storage to Supabase Storage.

## Features

- **Profile Images**: Downloads and imports student profile pictures
- **Progress Photos**: Downloads and imports studio progress photos linked to students
- **Error Recovery**: Comprehensive retry logic for failed downloads
- **Resume Capability**: Skips already imported images (can be run multiple times safely)
- **Batch Processing**: Processes images in configurable batches to avoid overwhelming servers
- **Detailed Logging**: Complete logs with progress tracking and error reporting
- **Organized Storage**: Creates well-structured folder hierarchy in Supabase Storage

## Prerequisites

- Node.js (v14 or newer)
- Supabase project with storage enabled
- Environment variables configured (`.env.local` file)
- **CRITICAL**: `id-mappings.json` file must exist in the `scripts/` folder (generated by `import-all.js`)

## Installation

The script uses the same dependencies as the main import script:

```bash
cd scripts
npm install # or yarn install
```

## Environment Setup

Ensure your `.env.local` file contains:

```
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

## Usage

```bash
node import-images.js <path_to_json_file>
```

### Examples

```bash
# Import from the sample database
node import-images.js import_all/sample_db.json

# Import from the full export
node import-images.js import_all/arnold-89303-export-final.json
```

## ⚠️ CRITICAL REQUIREMENT: ID Mappings

**This script REQUIRES the `id-mappings.json` file to be present in the `scripts/` folder.**

### How to ensure it exists:
1. **First run**: `node import-all.js import_all/sample_db.json` (generates id-mappings.json)
2. **Then run**: `node import-images.js import_all/sample_db.json` (uses id-mappings.json)

### What the script does with id-mappings.json:
- Maps old MongoDB student IDs to new Supabase UUIDs
- Links profile images to the correct students
- Associates progress photos with the right student-studio relationships
- Without this file, images will not be linked to students correctly

### File structure requirement:
```
scripts/
├── import-all.js
├── import-images.js
├── id-mappings.json  ← MUST EXIST HERE
└── import_all/
    └── sample_db.json
```

## Storage Structure

The script organizes images in Supabase Storage following the app's existing patterns:

### Single Bucket Structure
All images are stored in the `images` bucket with organized folder paths:

```
images/
├── profile_pictures/
│   ├── student-id-1/
│   │   └── image-filename.png
│   ├── student-id-2/
│   │   └── image-filename.png
│   └── ...
└── progress_photos/
    ├── studio-student-id-1/
    │   ├── photo1.png
    │   └── photo2.png
    ├── studio-student-id-2/
    │   └── photo3.png
    └── ...
```

## Configuration

You can modify these settings at the top of the script:

```javascript
const CONFIG = {
  IMAGES_BUCKET: "images",               // Main storage bucket (matches app)
  MAX_RETRIES: 3,                        // Retry attempts for failed downloads
  RETRY_DELAY: 2000,                     // Delay between retries (ms)
  DOWNLOAD_TIMEOUT: 30000,               // Download timeout (ms)
  CONCURRENT_DOWNLOADS: 5,               // Batch size for concurrent processing
};
```

## Logging

The script creates detailed logs in the `logs/` directory:

- `import-images.log` - Complete import log
- `import-images-error.log` - Error-only log

## Data Processing

### Profile Images

1. **Source**: `students[id].profile_image` field in the JSON export
2. **Format**: `profile_images/student-id/filename`
3. **Firebase URL**: Auto-generated from the path
4. **Supabase Path**: `profile_pictures/{new-student-id}/{filename}.png` (in `images` bucket)
5. **Database**: Updates `student.profile_picture_url` with the full Supabase storage URL:
   ```
   http://localhost:54321/storage/v1/object/public/images/profile_pictures/{student-id}/{filename}.png
   ```

### Progress Photos

1. **Source**: `photos` collection where `path` contains `progress_photos`
2. **Format**: `progress_photos/student-id/photo-filename`
3. **Student Linking**: Student ID extracted from the path, mapped to new ID
4. **Studio Linking**: Studio ID from the `studio` field, mapped to new ID
5. **Relationship**: Uses `studio_student_id` from the relationship table
6. **Supabase Path**: `progress_photos/{studio-student-id}/{filename}.png` (in `images` bucket)
7. **Database**: Inserts records into `progress_photos` table with full Supabase storage URLs:
   ```
   http://localhost:54321/storage/v1/object/public/images/progress_photos/{studio-student-id}/{filename}.png
   ```

## Error Handling

- **Network Issues**: Automatic retry with exponential backoff
- **Missing Files**: Logged as warnings, process continues
- **Invalid Paths**: Skipped with detailed logging
- **Orphaned Photos**: Progress photos without matching students are logged
- **Duplicate Files**: Existing files are skipped (resume capability)

## Resume and Recovery

The script can be safely run multiple times:

- Already imported images are automatically detected and skipped
- Failed imports can be retried by running the script again
- Partial imports can be completed without re-downloading successful images
- **Database records are inserted immediately after each batch upload**, so interrupting the script midway will still preserve database consistency for completed batches
- **Duplicate prevention**: Database records are only created for new uploads, not for files that already exist in storage, preventing duplicate database entries

## Output Example

```
info: Starting Prospire Image Import Process
info: Connecting to Supabase at http://localhost:54321
info: Checking if bucket 'progress-photos' exists...
info: Bucket 'progress-photos' already exists
info: Data overview: 62 students, 20 photos
info: Starting profile image import...
info: Found 15 students with profile images out of 62 total students
info: Processing profile image batch 1/3
info: Processing profile image for student -M7IkHbMXHXqZO1IPBLH: profile_images/-M7IkHbMXHXqZO1IPBLH/F61116211742 -> profile-images/-M7IkHbMXHXqZO1IPBLH/F61116211742.png
info: Successfully uploaded: profile-images/-M7IkHbMXHXqZO1IPBLH/F61116211742.png
...
info: Profile image import completed: 15 successful, 0 skipped, 0 failed
info: Starting progress photo import...
info: Found 8 progress photos in total
info: Organized photos: 3 students have progress photos
info: Prepared 8 progress photos for import
...
info: Progress photo import completed: 8 successful, 0 skipped, 0 failed

IMPORT SUMMARY
Profile Images:
  Processed: 15
  Successful: 15
  Skipped: 0
  Failed: 0

Progress Photos:
  Processed: 8
  Successful: 8
  Skipped: 0
  Failed: 0

TOTAL RESULTS: 23 successful, 0 skipped, 0 failed
info: All images processed successfully!
```

## Troubleshooting

### Common Issues

1. **Missing id-mappings.json**: 
   - **Error**: "Failed to load ID mappings"
   - **Solution**: Run `import-all.js` first to generate the mappings file
   
2. **Network Timeouts**: Increase `DOWNLOAD_TIMEOUT` in config
3. **Rate Limiting**: Reduce `CONCURRENT_DOWNLOADS` or increase delays
4. **Storage Permissions**: Ensure service role key has storage access
5. **Missing Bucket**: Script will attempt to create it automatically

### Debug Mode

Enable debug logging by setting the log level to 'debug' in the script:

```javascript
level: "debug",  // Change from "info" to "debug"
```

## Notes

- All images are converted to PNG format for consistency
- Original filenames are preserved but with `.png` extension
- Firebase Storage URLs are auto-generated with proper encoding
- The script validates data structure before processing
- Storage bucket is created automatically if it doesn't exist